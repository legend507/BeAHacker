/*
From "Hacking: the art of exploitation"

GNU C compiled programs have table sections .dtors and .ctors for destructors and constructors.
    Note: after GNU C 4.7, .dtors and .ctors are not used, intead look for .init_array and .fini_array
Constructor functions are executed before main(), destructor functions are executed just before main() is about to end

*/

#include <stdio.h>
#include <stdlib.h>

// give genesis "constructor" attribute, executed before main()
static void genesis(void) __attribute__ ((constructor));

// give cleanup() destructor attribute, in this way we can define cleanup() a destructor func
static void cleanup(void) __attribute__ ((destructor));

main() {
    printf("Some Actions happen in main() function...\n");
    printf("and then when main() exits, the destructor is called...\n");

    exit(0);
}

void genesis(void) {
    printf("In the genesis func...\n");
}

void cleanup(void) {
    printf("In the cleanup func...\n");
}

/*
1. $ nm ./a.out, to check the symbol table of the a.out executable file (also, objdump -x a.out can print all info)
    This exploit (Hacking: the art of exploitation p.184) cease to work because GNC C no longer use .dtors.

The take away from this is, if I found a executable file that has .dtors, then I shall know it is exploitable.
*/
